<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/friendlist.css">
    <title>我的好友清單</title>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="jquery-3.3.1.min.js"></script>
  <!--選擇使用realtime database功能-->
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-database.js"></script>
    <script src="http://code.changer.hk/jquery/plugins/jquery.cookie.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.3.0/firebase-storage.js"></script>
  <script type="text/javascript">

    var firebaseConfig = {
        apiKey: "AIzaSyCcIFB1orespqziBWnX8kUWyihopdBw8jM",
        authDomain: "japungo.firebaseapp.com",
        databaseURL: "https://japungo.firebaseio.com",
        projectId: "japungo",
        storageBucket: "japungo.appspot.com",
        messagingSenderId: "238647383425",
        appId: "1:238647383425:web:cd43c3708893b6e052c480"
      };
      // Initialize Firebase 初始化
      firebase.initializeApp(firebaseConfig);
      </script>
  <script defer type="text/javascript" src='js/contact_us.js'></script>    
</head>
<body>
    <div class="wrap">
        <div class="header">
            <img src="img/logo_header.png" class="logo">
            <div id="toggle">
                    <div class="one"></div>
                    <div class="two"></div>
                    <div class="three"></div>
            </div>

            <nav id="menu">
                 <ul>
                    <li><a href="index.html"><img src="img/home.png" alt="">首頁</a></li>
                    <li><a href="game.html"><img src="img/game.png" alt="">今天吃什麼</a></li>
                    <li><a href="posts.html"><img src="img/posts.png" alt="">我的動態</a></li>
                    <li><a href="search.html"><img src="img/search.png" alt="">搜尋美食</a></li>
                    <li><a href="foodlist.html"><img src="img/foodlist.png" alt="">美食清單</a></li>
                    <li><a href="friendlist.html"><img src="img/friendlist.png" alt="">好友清單</a></li>
                    <li><a href="member.html#1"><img src="img/member.png" alt="">修改會員資料</a></li>
                    <li><a href="member.html#2"><img src="img/friend_request.png" alt="">好友邀請</a></li>
                    <li><a href="member.html#3"><img src="img/comment.png" alt="">我的評論</a></li>
                    <li><a href="member.html#4"><img src="img/logout.png" alt="">登出</a></li>
               </ul>
            </nav>
        </div>
        <div class="clear"></div>

        <div class="title">
            <h1>我的好友清單</h1>
            <p>以帳號搜尋好友，立即發送好友邀請</p>
            <div class="inputArea">
                <input type="text" class="searchTerm" id="search">
                <button type="submit" class="searchBtn" onclick=friendInfo()><img src="img/search.png" alt=""></button>
            </div>
        </div>
        <div class="clear"></div>

        <div id="friendInfo">
            <button id="close"><img src="img/cross.png" alt=""></button>
            <img src="img/pic.png" alt=""  id="memberImg">
            <h3 class=memberName>用戶名</h3>
            <button id="addFriend">加入好友</button>
        </div>

        <div class="content">
            <div class="friendlist">
                <div class="info">
                    <img src="img/pic.png" class="addIcon">
                    <h3>用戶名</h3>
                    <button><a href="foodlist.html">查看美食清單</a></button>
                    <!-- <title>我的美食清單</title>和<h1>我的美食清單</h1>
                        改<title>xxx的美食清單</title>和<h1>xxx的美食清單</h1>-->
                    <button>刪除</button>
                </div>
            </div>
        </div>

        <div class="clear"></div>
        
        <div class="footer">
            <div class="left">
                <img src="img/logo_mini.png" alt="" class="logo_footer">
                <h3>聯絡我們</h3>
                <p>如有任何問題，請留下您的問題與聯絡信箱，我們將儘速與您聯繫</p>
            </div>
            
            <div class="right">
                <textarea style="overflow:auto" class="questionTerm" placeholder="請輸入您的問題"></textarea>
                <div class="emailArea">
                    <input type="email" class="emailTerm" id='emailTerm' placeholder="請輸入您的信箱">
                    <button type="submit" class="submitBtn" id='submitBtn'><img src="img/send.png" alt="" class="contact"></button>
                </div> 
            </div> 
            
            <button id="backTop" class="toTop"></button>
        </div>
    </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script>
        $( document ).ready(function() {
            $('#menu').hide();
            $('#toggle').click(function() {
                $('#menu').slideToggle();
            });
        });

        

        $(function(){
            $('#backTop').click(function(){ 
                $('html,body').animate({scrollTop:0}, 333);
            });

            $(window).scroll(function() {
                if ( $(this).scrollTop() > 300 ){
                    $('#backTop').fadeIn(222);
                } else {
                    $('#backTop').stop().fadeOut(222);
                }
            }).scroll();

        });
    </script>
    <script type="text/javascript">
        
        
        var list=document.querySelector('.friendlist');
        $(document).ready(function(){
            var frienddata=firebase.database().ref('/好友名單資料/');
            var memberdata=firebase.database().ref('/會員資料/');
            var str='';
            var MyID=getCookie('ID');

            frienddata.once('value',function(friendsnapshot){
                memberdata.once('value',function(membersnapshot){
                var memberInf=membersnapshot.val();
                var friendInf=friendsnapshot.val();
                for(var i in friendInf){
                    if(friendInf[i]["ANo"]==MyID&&friendInf[i]["Status"]==true){
                     
                        for(var j in memberInf){

                            if(friendInf[i]["SNo"]==memberInf[j]["ID"]){
                                str+=memberInf[j]["Name"];
                                str+='<button onclick=foodlist("'+j+'")>'+"查看美食清單"+'</button>';
                                str+='<button onclick=delfrined("'+i+'")>'+"刪除好友"+'</button>';
                            }
                        }
                    }else if(friendInf[i]["SNo"]==MyID&&friendInf[i]["Status"]==true){
                        for(var j in memberInf){
                            if(friendInf[i]["ANo"]==memberInf[j]["ID"]){
                                str+=memberInf[j]["Name"];
                                str+='<button onclick=foodlist("'+j+'")>'+"查看美食清單"+'</button>';
                                str+='<button onclick=delfrined("'+i+'")>'+"刪除好友"+'</button>';
                            }

                        }
                    }
                }
                list.innerHTML=str;
            });
        });
//-------------------------------------------------------
$('#addFriend').on('click',function(){
        var search=$('#search').val();
        var frienddata=firebase.database().ref('/好友名單資料/');
        var count=0;
        frienddata.once('value',function(friendsnapshot){
            var friendInf=friendsnapshot.val();
            for(var i in friendInf){
                if(friendInf[i]["ANo"]==search&&friendInf[i]["SNo"]==getCookie('ID')){
                    if(friendInf[i]["Status"]==true){
                        alert("此帳號已經是好友了！");
                        count++;
                    }else{
                        alert("已送出邀請等待對方回覆");
                        count++;
                    }
                }else if(friendInf[i]["ANo"]==getCookie('ID')&&friendInf[i]["SNo"]==search){
                   if(friendInf[i]["Status"]==true){
                        alert("你們已經是好友囉！");
                        count++;
                   }else{
                        alert("對方已經邀請你，請至我的好友邀請名單中接受邀請");
                        count++;
                   } 
                }

            }
            if(count==0){
                    frienddata.push({
                        ANo:search,
                        SNo:getCookie('ID'),
                        Status:false,
                    });
                    alert('已送出邀請');
            }
            
        });
    });
        });
function getCookie(name) {
            var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");

        if (arr = document.cookie.match(reg))

            return unescape(arr[2]);
        else
            return null;
        }
function foodlist(j){
    document.cookie="FNo="+j;
    window.location.href="foodlist.html";
}
function delfrined(i){
    deldata=firebase.database().ref('/好友名單資料/'+i);
    deldata.remove();

}
function friendInfo (){
    //----------------------------------------------------------------前端
            var friendInfo = document.getElementById("friendInfo");
            friendInfo.style.display = "none";
            $('.searchBtn').click(function centerHandler(){ 
                friendInfo.style.display = "block";
                var scrollDist = $(window).scrollTop();
                var myTop = "100px";
                var myLeft = ($(window).width()-$("#friendInfo").width())/2;
                $("#friendInfo").offset({left:myLeft});
                
                $(window).resize(centerHandler);
            });
 
            $('#close').click(function(){
                friendInfo.style.display = "none";
            });
    //----------------------------------------------------------------
    var search=$('#search').val();
    var memberdata=firebase.database().ref('會員資料');
    var Namestr='';
    var Name=document.querySelector('.memberName');
    var memberImg=document.querySelector('.memberImg');
    memberdata.once('value',function(membersnapshot){
        memberInf=membersnapshot.val();

        for(var i in memberInf){
            if(memberInf[i]["ID"]==search){
                Namestr+=memberInf[i]["Name"];
                changeImg(memberInf[i]["ID"]);
                // var storageRef=firebase.storage().ref('/user/'+memberInf[i]["ID"]);
            }
        }
        Name.innerHTML=Namestr; 
    });
}
function changeImg(i){
    window.onload=function(){


    var Imgdata=firebase.storage().ref('/user/'+i);
    
        var memberImg=document.querySelector('.memberImg');
        console.log(Imgdata);
        // console.log(Imgdata.location.bucket);
        // console.log(Imgdata.location.path);
        memberImg.src=Imgdata;
    
};
    
}
    </script>
</body>

</html>