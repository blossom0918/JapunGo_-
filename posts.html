<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/posts.css">
    <title>我的動態</title>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="jquery-3.3.1.min.js"></script>
    <!--選擇使用realtime database功能-->
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-database.js"></script>
    <script src="http://code.changer.hk/jquery/plugins/jquery.cookie.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.3.0/firebase-storage.js"></script>
    <script type="text/javascript">
    var firebaseConfig = {
        apiKey: "AIzaSyCcIFB1orespqziBWnX8kUWyihopdBw8jM",
        authDomain: "japungo.firebaseapp.com",
        databaseURL: "https://japungo.firebaseio.com",
        projectId: "japungo",
        storageBucket: "japungo.appspot.com",
        messagingSenderId: "238647383425",
        appId: "1:238647383425:web:cd43c3708893b6e052c480"
      };
      // Initialize Firebase 初始化
      firebase.initializeApp(firebaseConfig);
      </script>
</head>
<body>
    <div class="wrap">
        <div class="header">
            <img src="img/logo_header.png" class="logo">
            <div id="toggle">
                    <div class="one"></div>
                    <div class="two"></div>
                    <div class="three"></div>
            </div>

            <nav id="menu">
                 <ul>
                    <li><a href="game.html"><img src="img/game.png" alt="">今天吃什麼</a></li>
                    <li><a href="posts.html"><img src="img/posts.png" alt="">我的動態</a></li>
                    <li><a href="search.html"><img src="img/search.png" alt="">搜尋美食</a></li>
                    <li><a href="foodlist.html"><img src="img/foodlist.png" alt="">美食清單</a></li>
                    <li><a href="friendlist.html"><img src="img/friendlist.png" alt="">好友清單</a></li>
                    <li><a href="member.html#1"><img src="img/member.png" alt="">修改會員資料</a></li>
                    <li><a href="member.html#2"><img src="img/friend_request.png" alt="">好友邀請</a></li>
                    <li><a href="member.html#3"><img src="img/comment.png" alt="">我的評論</a></li>
                    <li><a href="member.html#4"><img src="img/logout.png" alt="">登出</a></li>
                </ul>
            </nav>
        </div>
        <div class="clear"></div>

        <div class="title">
            <h1>我的動態</h1> 
            <p>錯過了好多動態，快來補齊和好友相邀吃飯去</p> 
        </div>
        <div class="clear"></div>

        <div class="content">
            <div class="status">
                <div class="statusContent">
                    <div class="moreCompanion" id="moreCompanion" style="display: none;">
                        <img src="img/pic.png" alt="">
                    </div>
                    
                    <div class="companion">
                        <!-- 放已加入者頭貼處，超過五人顯示<button><img src="img/view_more.png" id="viewMore"></button>
                                按下後顯示<div class="moreCompanion" style="display: none;"></div>裡頭為剩下未顯示的加入者頭貼-->
                        <button id="viewMore"><img src="img/view_more.png" id="viewMoreImg"></button>                                             
                        <img src="img/pic.png" alt="">
                    </div>

                    <img src="img/pic.png" class="writerImg">
                    <h3 class="writer">發布者</h3>
                    <p class="time">時間</p>
                    <div class="post_detail">
                        <div class="eatTime" id="eatTime">飯局時間</div>
                        <div class="postContent" id="postContent">內容</div>
                        <button id="confirmEdit">確認修改</button>
                        <button id="cancelEdit">取消修改</button>
                    </div>                  

                    <div class="bottom">
                        <button id="restaurant">餐廳名</button>

                        <!-- 自己的動態顯示<div class="btn_my_posts">，別人的顯示<div class="btn_others_posts"> -->
                        <div class="btn_my_posts">
                            <button>刪除</button>
                            <button id="edit">修改</button>
                        </div>

                        <div class="btn_others_posts">
                            <button>加入飯局</button>
                        </div>
                    </div>
                    
                    <div class="info" id="info" style="display: none;">
                        <button id="close"><img src="img/cross.png"></button>
                        <h3>餐廳名</h3>
            
                        <img src="img/pin.png" class="addIcon">
                        <p class="address">地址</p>
            
                        <img src="img/tel.png" class="telIcon">
                        <p class="tel">電話</p>
            
                        <div class="btn0">
                            <button class="showAllComments" id="showAllComments"><img src="img/show_comment.png" class="commentIcon">顯示評論區</button>                   
                            <a class="recommend"><img src="img/best.png" class="bestIcon">查看推薦</a>
                        </div>
            
                        <div class="btn">
                            <button id="post">發起動態</button>
                            <button id="comment">我要評論</button>
                            <button>加入清單／自清單移除</button>
                        </div>
                                
                        <div class="postArea">
                            <div class="postInput">
                                <textarea style="overflow:auto" class="postTerm" placeholder="請輸入動態內容"></textarea>
                                <img src="img/pic.png" alt="">
                            </div>
                            <div class="btn2">
                                    <button>確定</button>
                                    <button>取消</button>
                            </div>
                        </div>
                                                    
                        <div class="commentArea">
                            <div class="commentInput">
                                <textarea style="overflow:auto" class="commentTerm" placeholder="請輸入評論內容"></textarea>
                                <img src="img/pic.png" alt="">
                            </div>                    
                            <div class="btn3">
                                <button id="option">評論選項</button>
                                    <button>我要評論</button>
                            </div>
                            <div class="btnOption">
                                <button>環境乾淨</button>
                                <button>環境骯髒</button>
                                <button>餐點美味</button>
                                <button>餐點糟糕</button>
                                <button>親切店家</button>
                                <button>服務極差</button>
                            </div>
                        </div>            
                                
                        <div class="allComments">
                            <div class="comments">
                                <img src="img/pic.png" alt="">
                                <div class="commentContent">
                                    <p>內容</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="clear"></div>
        
        <div class="footer">
            <div class="left">
                <img src="img/logo_mini.png" alt="" class="logo_footer">
                <h3>聯絡我們</h3>
                <p>如有任何問題，請留下您的問題與聯絡信箱，我們將儘速與您聯繫</p>
            </div>
            
            <div class="right">
                <textarea id="suggestion" style="overflow:auto" class="questionTerm" placeholder="請輸入您的問題"></textarea>
                <div class="emailArea">
                    <input id="membermail" type="email" class="emailTerm" placeholder="請輸入您的信箱">
                    <button onclick=suggestion() type="submit" class="submitBtn"><img src="img/send.png" alt="" class="contact"></button>
                </div> 
            </div> 
       
            <button id="backTop" class="toTop"></button>
        </div>
    </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script>
        $( document ).ready(function() {
            $('#menu').hide();
            $('#toggle').click(function() {
                $('#menu').slideToggle();
            });

            // 以下這些要改成以各別id判斷要不要展開

            $('.postArea').hide();
            $('#post').click(function() {
                $('.postArea').slideToggle();
                $('.commentArea').hide();
                $('.allComments').hide();
            });

            $('.commentArea').hide();
            $('#comment').click(function() {
                $('.commentArea').slideToggle();
                $('.postArea').hide();
                $('.allComments').hide();
            });

            $('.btnOption').hide();
            $('#option').click(function() {
                $('.btnOption').slideToggle();
            });

            $('.allComments').hide();
            $('#showAllComments').click(function() {
                $('.allComments').slideToggle();
                $('.commentArea').hide();
                $('.postArea').hide();
            });

        });
        
        $(function(){
            var moreCompanion = document.getElementById('moreCompanion');
            
            $('#viewMore').click(function() {
                if(moreCompanion.style.display == "none"){
                    moreCompanion.style.display = "block";
                }else{
                    moreCompanion.style.display = "none";
                }       
                
            });
        });

        $(function(){
            $('#backTop').click(function(){ 
                $('html,body').animate({scrollTop:0}, 333);
            });
            $(window).scroll(function() {
                if ( $(this).scrollTop() > 300 ){
                    $('#backTop').fadeIn(222);
                } else {
                    $('#backTop').stop().fadeOut(222);
                }
            }).scroll();
        });

        $(function(){
            $('#restaurant').click(function centerHandler() {
                document.getElementById('info').style.display = "block";
                var scrollDist = $(window).scrollTop();
                var myTop = ($(window).height()-$('#info').height())/2;
                var myLeft = ($(window).width()-$('#info').width())/2;
                $('#info').offset({top:myTop, left:myLeft});
                
                $(window).resize(centerHandler);
            });
 
            $('#close').click(function(){
                document.getElementById('info').style.display = "none";
            });
        });

//-----------------------------------------------後端
        var statusdata=firebase.database().ref('/動態資料/');
        var memberdata=firebase.database().ref('/會員資料/');
        var frienddata=firebase.database().ref('/好友名單資料/');
        $( document ).ready(function() {
            var status=document.querySelector('.status');
            memberdata.once('value',function(membersnapshot){
                statusdata.once('value',function(statussnapshot){
                    frienddata.once('value',function(fsnapshot){
                        var friendInf=fsnapshot.val();
                        var memberInf=membersnapshot.val();
                        var statusInf=statussnapshot.val();
                        var ID=getCookie('ID');
                        var str=''; 
                        for(var s in statusInf){
                            if(statusInf[s]["UNo"]==ID){
                                // str+='<div class="status">';
                                str+='<div class="statusContent" id="statusContent'+s+'">';
                                str+='<div class="moreCompanion" id="moreCompanion" style="display: none;"><img src="img/pic.png" alt=""></div>';
                                str+='<div class="companion">';
                                        // <!-- 放已加入者頭貼處，超過五人顯示
                                        // 按下後顯示<div class="moreCompanion" style="display: none;"></div>裡頭為剩下未顯示的加入者頭貼-->\
                                str+=' <button id="viewMore"><img src="img/view_more.png" id="viewMoreImg"></button>';      
                                str+='<img src="img/pic.png" alt="">';
                                str+='</div>';
                                str+='<img src="img/pic.png" class="writerImg">';
                                str+='<h3 class="writer">自己</h3>';
                                str+='<p class="time">'+statusInf[s]["Date"]+'</p>';

                                str+='<div class="post_detail"><p class="eatTime" id="eatTime'+s+'">'+statusInf[s]["EatTime"]+'</p>';
                                str+='<p class="postContent" id="postContent'+s+'">'+statusInf[s]["Content"]+'</p>';
                                str+='<button class="confirmEdit" id="confirmEdit'+s+'">確認修改</button><button class="cancelEdit" id="cancelEdit'+s+'">取消修改</button></div>';

                                str+='<div class="bottom">';
                                str+='<button id="restaurant" onclick=showInf("'+s+'")>'+statusInf[s]["Name"]+'</button>';             
                                str+='<div class="btn_my_posts">';//自己的動態                                                    
                                str+='<button onclick=delpost("'+s+'")>刪除</button>';
                                str+='<button onclick=edit("'+s+'")>修改</button>';
                                str+='</div>';
                                str+='</div></div>';
                                str+='<div class="info" id="info'+s+'" style="display: none;">';
                                str+='<button id="close"><img src="img/cross.png"></button>';
                                str+='<h3>'+statusInf[s]["Name"]+'</h3>';
                                str+='<img src="img/pin.png" class="addIcon">';
                                str+='<p class="address">'+statusInf[s]["Address"]+'</p>';
                                str+='<img src="img/tel.png" class="telIcon">';
                                str+='<p class="tel">'+statusInf[s]["Phone"]+'</p>';
                                str+='<div class="btn0">';
                                str+='<button class="showAllComments" id="showAllComments"><img src="img/show_comment.png" class="commentIcon">顯示評論區</button>';
                                str+='<a class="recommend"><img src="img/best.png" class="bestIcon">查看推薦</a></div>';
                                str+='<div class="btn">';
                                str+='<button id="post" onclick=post("'+s+'")>發起動態</button>';
                                str+='<button id="comment">我要評論</button>';
                                str+='<button>加入清單／自清單移除</button></div>';
                                str+='<div class="postArea" style="display: none;" id="postArea'+s+'">';
                                str+='<div class="postInput">';
                                str+='<input type="text" class="eatTimeTerm" placeholder="請輸入飯局時間" id="eatTimeTerm'+ s + '">';
                                str+='<textarea style="overflow:auto" class="postTerm" placeholder="請輸入動態內容" id="postTerm'+s+'"></textarea>';
                                str+='<img src="img/pic.png" alt=""></div>';
                                str+='<div class="btn2">';
                                str+='<button id="sure'+s+'">確定</button>';
                                str+='<button id="cancel'+s+'">取消</button>';
                                str+='</div></div>';
                                str+='<div class="commentArea" style="display: none;" id="commentArea'+s+'">';
                                str+='<div class="commentInput">';
                                str+='<textarea style="overflow:auto" class="commentTerm" placeholder="請輸入評論內容"></textarea>';
                                str+='<img src="img/pic.png" alt=""></div>';
                                str+='<div class="btn3">';
                                str+='<button id="option">評論選項</button>';
                                str+='<button>我要評論</button>';
                                str+='</div>';
                                str+='<div class="btnOption" style="display: none;">';
                                str+='<button>環境乾淨</button>\
                                    <button>環境骯髒</button>\
                                    <button>餐點美味</button>\
                                    <button>餐點糟糕</button>\
                                    <button>親切店家</button>\
                                    <button>服務極差</button></div></div>';
                                str+='<div class="allComments" style="display: none;">';
                                str+='<div class="comments">';
                                str+='<img src="img/pic.png" alt="">';
                                str+='<div class="commentContent">';
                                str+='<p>內容</p>';
                                str+='</div></div></div></div></div>';
                            }
                        
                        }
                        status.innerHTML=str;

                        $('.confirmEdit').hide();
                        $('.cancelEdit').hide();
                    });
                });
            });
        });


function edit(i){
    var confirmEdit = "#confirmEdit" + i;
    $(confirmEdit).show();
    var cancelEdit = "#cancelEdit" + i;
    $(cancelEdit).show();

    var eatTime = "#eatTime" + i;
    var postContent = "#postContent" + i;
    
    var input = $("<textarea class='textarea'></textarea>");
    var oldtext = $(eatTime).html();
    input.width($(eatTime).width());
    input.val($(eatTime).html());
    $(eatTime).html("");
    input.appendTo($(eatTime)).focus().select();
    
    var input2 = $("<textarea class='textarea'></textarea>");
    var oldtext2 = $(postContent).html();
    input2.width($(postContent).width());
    input2.val($(postContent).html());
    $(postContent).html("");
    input2.appendTo($(postContent)).focus().select();

    $(confirmEdit).click(function(){
        $(eatTime).html(input.val());
        $(postContent).html(input2.val());
        $(confirmEdit).hide();
        $(cancelEdit).hide();
    });

     $(cancelEdit).click(function(){
        $(eatTime).html(oldtext);
        $(postContent).html(oldtext2);
        $(confirmEdit).hide();
        $(cancelEdit).hide();
    });
       
}

function post(i){
    var commentArea = '#commentArea' + i;
            $(commentArea).hide();
            var postArea = '#postArea' + i;
            var sure = '#sure' + i;
            var cancel = '#cancel' + i;
            var postTerm = '#postTerm' + i;
            var ID = getCookie('ID');
            var Today = new Date();
            var Today2 = +new Date();
            var newjoin = ID + Today2;
            $(postArea).slideToggle();
            $(sure).on('click', function () {
                var id = 'postTerm' + i
                var newpost = document.getElementById(id).value;
                var eatTimeTerm = 'eatTimeTerm' + i;
                var neweatTime = document.getElementById(eatTimeTerm).value;
                var postdata = firebase.database().ref('/動態資料/');
                var fooddata = firebase.database().ref('/美食清單資料/');
                if (neweatTime == '') {
                    alert("請輸入要吃飯的時間");
                } else {
                    fooddata.once('value', function (fsnapshot) {
                        var foodInf = fsnapshot.val();
                        for (var f in foodInf) {
                            for (var f2 in foodInf[f]) {
                                if (f2 == i) {
                                    var postAddress = foodInf[f][f2]["Address"];
                                    var postPhone = foodInf[f][f2]["Phone"];
                                    var postName = foodInf[f][f2]["Name"];
                                }
                            }
                        }
                        postdata.push({
                            EatTime: neweatTime,
                            JoinKey: ID + Today2,
                            Address: postAddress,
                            Phone: postPhone,
                            Name: postName,
                            Content: newpost,
                            UNo: ID,
                            PDate: Today.getFullYear() + "/" + (Today.getMonth() + 1) + "/" + Today.getDate(),

                        });
                        setTimeout(() => {
        document.getElementById(id).value = '';
        document.getElementById(eatTimeTerm).value = ''
        document.getElementById(id).placeholder = Today.getFullYear() + "/" + (Today.getMonth() + 1) + "/" + Today.getDate() + "動態發佈成功!!";
    }, 0);
                       

                    });
                }

                firebase.database().ref('/加入飯局資料/"' + newjoin + '"').push(ID);
                $(postArea).style = "display:none";
            });

        }
        function getCookie(name) {
            var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
            if (arr = document.cookie.match(reg))
                return unescape(arr[2]);
            else
                return null;
        }
        function delfoodlist(j) {
            var ID=getCookie('ID');
            document.querySelector('.info').style="display:none";
            var delfood = firebase.database().ref('/美食清單資料/'+ID+'/'+j);
            delfood.remove();
            alert("此清單已刪除");
}
function delpost(s){
    var statusContent='#statusContent'+s;
    $(statusContent).hide();
    firebase.database().ref('/動態資料/'+s).remove();
    alert("動態已刪除");

}
function showInf(s){
    var info='#info'+s;
    $(info).show();
}





function getCookie(name) {
    var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
    if (arr = document.cookie.match(reg))
        return unescape(arr[2]);
    else{
                return null;
    }
}

function suggestion(){
    var suggestion=$('#suggestion').val();
    var membermail=$('#membermail').val();
    var problem=firebase.database().ref('/問題回報/');
    problem.push({
        question:suggestion,
        email:membermail,
    });
    alert("感謝您的意見！");
} 

    </script>
</body>
</html>